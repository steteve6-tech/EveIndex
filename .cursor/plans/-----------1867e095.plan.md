<!-- 1867e095-c058-4c83-847d-2ccc668704b5 b87b6e61-b920-4bb3-b22a-12b45371fb50 -->
# 爬虫调度管理平台重构方案

## 一、后端实现（Spring Boot）

### 1. 爬虫注册中心模块

#### 1.1 增强CrawlerRegistryService

**文件**: `spring-boot-backend/src/main/java/com/certification/service/crawler/CrawlerRegistryService.java`

添加功能：

- 爬虫启用/停用状态管理（使用Map存储状态）
- 添加方法：`enableCrawler(String crawlerName)` - 启用爬虫
- 添加方法：`disableCrawler(String crawlerName)` - 停用爬虫
- 添加方法：`isCrawlerEnabled(String crawlerName)` - 检查状态
- 修改`getAllCrawlerInfo()`返回启用状态

#### 1.2 创建爬虫适配器（关键）

**位置**: `spring-boot-backend/src/main/java/com/certification/service/crawler/adapter/`

为每个爬虫创建适配器类实现`ICrawlerExecutor`接口：

- `US510KAdapter.java` - 注入US_510K爬虫类
- `USRecallAdapter.java` - 注入US_recall_api爬虫类
- `USRegistrationAdapter.java` - 注入US_registration爬虫类
- `EURecallAdapter.java` - 注入Eu_recall爬虫类
- 等11个适配器（覆盖所有已实现的爬虫）

适配器模板：

```java
@Component("US_510K_Adapter")
public class US510KAdapter implements ICrawlerExecutor {
    @Autowired
    private US_510K crawler;
    
    @Override
    public String getCrawlerName() { return "US_510K"; }
    
    @Override
    public String getCountryCode() { return "US"; }
    
    @Override
    public String getCrawlerType() { return "510K"; }
    
    @Override
    public CrawlerResult execute(CrawlerParams params) {
        // 参数转换和调用爬虫方法
    }
}
```

### 2. 参数预设管理模块

#### 2.1 增强UnifiedTaskConfigRepository

**文件**: `spring-boot-backend/src/main/java/com/certification/repository/UnifiedTaskConfigRepository.java`

添加查询方法：

- `findByCrawlerNameAndTaskName(String crawlerName, String taskName)` - 查询特定预设
- `findAllPresets()` - 查询所有预设类型任务（taskType = 'PRESET'）

#### 2.2 创建参数预设Service

**文件**: `spring-boot-backend/src/main/java/com/certification/service/crawler/ParamPresetService.java`

实现功能：

- `createPreset(PresetRequest)` - 创建参数预设，参数基于Schema验证
- `updatePreset(Long id, PresetRequest)` - 更新预设
- `copyPreset(Long id, String newName)` - 复制预设
- `deletePreset(Long id)` - 删除预设及关联任务
- `getPresetsByCondition(String crawlerName, Boolean enabled)` - 条件查询
- `validatePresetParams(String crawlerName, String params)` - 基于Schema验证参数

### 3. 动态定时调度模块

#### 3.1 创建DynamicTaskSchedulerService

**文件**: `spring-boot-backend/src/main/java/com/certification/service/crawler/DynamicTaskSchedulerService.java`

核心功能：

```java
@Service
public class DynamicTaskSchedulerService {
    @Autowired
    private TaskScheduler taskScheduler;
    
    private Map<Long, ScheduledFuture<?>> scheduledTasks = new ConcurrentHashMap<>();
    
    @PostConstruct
    public void initScheduledTasks() {
        // 加载所有enabled=true的任务
        List<UnifiedTaskConfig> tasks = taskConfigRepository.findByEnabled(true);
        for (UnifiedTaskConfig task : tasks) {
            scheduleTask(task);
        }
    }
    
    public void scheduleTask(UnifiedTaskConfig config) {
        // 解析Cron表达式并创建定时任务
        CronTrigger trigger = new CronTrigger(config.getCronExpression());
        ScheduledFuture<?> future = taskScheduler.schedule(
            () -> executeTask(config.getId()), trigger
        );
        scheduledTasks.put(config.getId(), future);
    }
    
    public void updateScheduledTask(Long taskId) {
        cancelTask(taskId);
        UnifiedTaskConfig task = taskConfigRepository.findById(taskId).orElseThrow();
        if (task.getEnabled()) {
            scheduleTask(task);
        }
    }
    
    public void cancelTask(Long taskId) {
        ScheduledFuture<?> future = scheduledTasks.remove(taskId);
        if (future != null) {
            future.cancel(false);
        }
    }
    
    public void pauseTask(Long taskId) { /* 暂停任务 */ }
    
    public void resumeTask(Long taskId) { /* 恢复任务 */ }
}
```

#### 3.2 添加Spring TaskScheduler配置

**文件**: `spring-boot-backend/src/main/java/com/certification/config/SchedulerConfig.java`

```java
@Configuration
@EnableScheduling
public class SchedulerConfig {
    @Bean
    public TaskScheduler taskScheduler() {
        ThreadPoolTaskScheduler scheduler = new ThreadPoolTaskScheduler();
        scheduler.setPoolSize(10);
        scheduler.setThreadNamePrefix("crawler-scheduler-");
        scheduler.initialize();
        return scheduler;
    }
}
```

### 4. 执行引擎与监控模块

#### 4.1 创建TaskExecutionService

**文件**: `spring-boot-backend/src/main/java/com/certification/service/crawler/TaskExecutionService.java`

功能实现：

```java
@Service
public class TaskExecutionService {
    @Autowired
    private CrawlerRegistryService crawlerRegistry;
    @Autowired
    private CrawlerSchemaRegistry schemaRegistry;
    @Autowired
    private UnifiedTaskLogRepository logRepository;
    
    @Transactional
    public CrawlerResult executeTask(UnifiedTaskConfig config, boolean isManual, String triggeredBy) {
        // 1. 创建执行日志
        UnifiedTaskLog log = new UnifiedTaskLog();
        log.setTaskId(config.getId());
        log.setTaskName(config.getTaskName());
        log.setCrawlerName(config.getCrawlerName());
        log.setIsManual(isManual);
        log.setTriggeredBy(triggeredBy);
        log.setStartTime(LocalDateTime.now());
        log.setStatus("RUNNING");
        logRepository.save(log);
        
        try {
            // 2. 参数校验
            CrawlerSchema schema = schemaRegistry.getSchema(config.getCrawlerName());
            Map<String, Object> params = parseParams(config.getParameters());
            if (!schemaRegistry.validateParams(config.getCrawlerName(), params)) {
                throw new IllegalArgumentException("参数验证失败");
            }
            
            // 3. 获取爬虫执行器
            ICrawlerExecutor executor = crawlerRegistry.getCrawler(config.getCrawlerName());
            
            // 4. 转换参数
            CrawlerParams crawlerParams = convertToCrawlerParams(params, config);
            
            // 5. 执行爬取
            CrawlerResult result = executor.execute(crawlerParams);
            
            // 6. 更新日志
            log.setEndTime(LocalDateTime.now());
            log.setStatus(result.getSuccess() ? "SUCCESS" : "FAILED");
            log.setSavedCount(result.getSavedCount());
            log.setSkippedCount(result.getSkippedCount());
            log.setResultMessage(result.getMessage());
            log.calculateDuration();
            logRepository.save(log);
            
            // 7. 更新任务配置统计
            config.updateExecutionStats(result.getSuccess(), result.getMessage());
            taskConfigRepository.save(config);
            
            return result;
            
        } catch (Exception e) {
            log.setStatus("FAILED");
            log.setErrorMessage(e.getMessage());
            log.setEndTime(LocalDateTime.now());
            logRepository.save(log);
            throw e;
        }
    }
    
    public void retryFailedTask(Long logId) { /* 重试逻辑 */ }
}
```

#### 4.2 创建监控统计Service

**文件**: `spring-boot-backend/src/main/java/com/certification/service/crawler/CrawlerMonitorService.java`

功能：

- `getRunningTasks()` - 获取运行中任务
- `getExecutionHistory(filters)` - 执行历史查询
- `getTaskStatistics(taskId)` - 任务统计
- `getSystemOverview()` - 系统总览

### 5. API接口完善

#### 5.1 完善UnifiedCrawlerController

**文件**: `spring-boot-backend/src/main/java/com/certification/controller/UnifiedCrawlerController.java`

添加接口：

**爬虫管理**

- `PUT /api/unified/crawlers/{name}/enable` - 启用爬虫
- `PUT /api/unified/crawlers/{name}/disable` - 停用爬虫

**参数预设管理**

- `POST /api/unified/presets` - 创建预设
- `GET /api/unified/presets` - 查询预设列表
- `GET /api/unified/presets/{id}` - 获取预设详情
- `PUT /api/unified/presets/{id}` - 更新预设
- `POST /api/unified/presets/{id}/copy` - 复制预设
- `DELETE /api/unified/presets/{id}` - 删除预设
- `POST /api/unified/presets/validate` - 验证参数

**定时任务管理**

- `POST /api/unified/tasks/{id}/schedule` - 创建定时任务
- `PUT /api/unified/tasks/{id}/schedule` - 更新定时任务
- `DELETE /api/unified/tasks/{id}/schedule` - 删除定时任务
- `POST /api/unified/tasks/{id}/pause` - 暂停任务
- `POST /api/unified/tasks/{id}/resume` - 恢复任务
- `POST /api/unified/tasks/{id}/trigger` - 手动触发

**监控查询**

- `GET /api/unified/monitor/running` - 运行中任务
- `GET /api/unified/monitor/history` - 执行历史
- `GET /api/unified/monitor/statistics/{taskId}` - 任务统计
- `GET /api/unified/monitor/overview` - 系统总览

## 二、前端实现（Vue3）

### 1. 重构UnifiedCrawlerManagement.vue

**文件**: `vue-frontend/src/views/UnifiedCrawlerManagement.vue`

#### 1.1 页面结构重构

```vue
<template>
  <div class="crawler-scheduler-platform">
    <!-- 顶部统计面板 -->
    <div class="statistics-panel">
      <a-statistic title="总爬虫数" :value="stats.totalCrawlers" />
      <a-statistic title="启用爬虫" :value="stats.enabledCrawlers" />
      <a-statistic title="预设任务" :value="stats.totalPresets" />
      <a-statistic title="成功率" :value="stats.successRate" suffix="%" />
    </div>

    <!-- 主标签页 -->
    <a-tabs v-model:activeKey="activeTab">
      <!-- Tab1: 爬虫管理 -->
      <a-tab-pane key="crawlers" tab="爬虫管理">
        <crawler-registry-panel />
      </a-tab-pane>

      <!-- Tab2: 参数预设 -->
      <a-tab-pane key="presets" tab="参数预设">
        <param-preset-panel />
      </a-tab-pane>

      <!-- Tab3: 监控中心 -->
      <a-tab-pane key="monitor" tab="监控中心">
        <execution-monitor-panel />
      </a-tab-pane>
    </a-tabs>
  </div>
</template>
```

#### 1.2 创建子组件

**爬虫注册管理组件**

**文件**: `vue-frontend/src/components/crawler/CrawlerRegistryPanel.vue`

功能：

- 爬虫列表展示（卡片式，显示名称、参数模板摘要、状态）
- 按国家/类型筛选
- 查看参数Schema详情（弹窗）
- 启用/停用爬虫按钮

**参数预设管理组件**

**文件**: `vue-frontend/src/components/crawler/ParamPresetPanel.vue`

功能：

- 预设列表表格（爬虫名称、预设名称、定时规则、启用状态）
- 创建预设按钮 -> 打开动态表单弹窗
- 编辑/复制/删除操作
- 启用/禁用预设
- 立即执行按钮

**动态参数配置表单**

**文件**: `vue-frontend/src/components/crawler/DynamicParamForm.vue`

核心功能：

```vue
<template>
  <a-modal v-model:open="visible" title="配置爬虫参数" width="800px">
    <a-form :model="formData" :label-col="{ span: 6 }">
      <!-- 基础信息 -->
      <a-form-item label="预设名称" required>
        <a-input v-model:value="formData.taskName" placeholder="如：爬取Abbott公司510K数据" />
      </a-form-item>

      <a-form-item label="选择爬虫" required>
        <a-select v-model:value="formData.crawlerName" @change="loadSchema">
          <a-select-option v-for="c in crawlers" :key="c.crawlerName" :value="c.crawlerName">
            {{ c.description }}
          </a-select-option>
        </a-select>
      </a-form-item>

      <!-- 动态参数字段 -->
      <div v-if="currentSchema">
        <a-divider>爬虫参数配置</a-divider>
        
        <!-- 根据Schema动态生成表单项 -->
        <a-form-item v-for="field in currentSchema.fields" :key="field.fieldName" 
                     :label="field.fieldLabel" :required="field.required">
          
          <!-- 关键词列表类型 -->
          <a-select v-if="field.fieldType === 'KEYWORD_LIST'" 
                    v-model:value="formData.params[field.fieldName]"
                    mode="tags" 
                    :placeholder="field.placeholder">
          </a-select>

          <!-- 文本类型 -->
          <a-input v-else-if="field.fieldType === 'TEXT'"
                   v-model:value="formData.params[field.fieldName]"
                   :placeholder="field.placeholder" />

          <!-- 数字类型 -->
          <a-input-number v-else-if="field.fieldType === 'NUMBER'"
                          v-model:value="formData.params[field.fieldName]"
                          :placeholder="field.placeholder" />

          <!-- 日期类型 -->
          <a-date-picker v-else-if="field.fieldType === 'DATE'"
                         v-model:value="formData.params[field.fieldName]" />
        </a-form-item>

        <!-- 通用参数 -->
        <a-divider>通用参数</a-divider>
        <a-form-item v-for="field in currentSchema.commonFields" :key="field.fieldName"
                     :label="field.fieldLabel">
          <a-input-number v-model:value="formData.params[field.fieldName]" 
                          :placeholder="field.placeholder" />
        </a-form-item>
      </div>

      <!-- 定时配置 -->
      <a-divider>定时配置</a-divider>
      <a-form-item label="Cron表达式" required>
        <a-input v-model:value="formData.cronExpression" placeholder="0 0 2 * * ?" />
        <cron-helper @select="formData.cronExpression = $event" />
      </a-form-item>

      <a-form-item label="启用任务">
        <a-switch v-model:checked="formData.enabled" />
      </a-form-item>
    </a-form>

    <template #footer>
      <a-button @click="validateAndSave">保存预设</a-button>
    </template>
  </a-modal>
</template>

<script setup>
import { ref, reactive } from 'vue';
import { getCrawlerSchema, createPreset, validateParams } from '@/api/crawler';

const formData = reactive({
  taskName: '',
  crawlerName: '',
  params: {},
  cronExpression: '',
  enabled: true
});

const currentSchema = ref(null);

async function loadSchema() {
  const res = await getCrawlerSchema(formData.crawlerName);
  currentSchema.value = res.data;
}

async function validateAndSave() {
  // 1. 验证参数
  const valid = await validateParams(formData.crawlerName, formData.params);
  if (!valid) {
    message.error('参数验证失败');
    return;
  }
  
  // 2. 保存预设
  await createPreset({
    taskName: formData.taskName,
    crawlerName: formData.crawlerName,
    parameters: JSON.stringify(formData.params),
    cronExpression: formData.cronExpression,
    enabled: formData.enabled,
    taskType: 'PRESET'
  });
  
  message.success('预设创建成功');
}
</script>
```

**Cron表达式辅助组件**

**文件**: `vue-frontend/src/components/crawler/CronHelper.vue`

提供常用Cron表达式选择：

- 每天凌晨2点：0 0 2 * * ?
- 每小时：0 0 * * * ?
- 每周一：0 0 2 ? * MON
- 自定义编辑器

**执行监控面板**

**文件**: `vue-frontend/src/components/crawler/ExecutionMonitorPanel.vue`

功能：

- 实时任务状态卡片（运行中任务列表）
- 执行历史表格（时间、爬虫、预设、结果、耗时、操作）
- 筛选条件：时间范围、爬虫、状态
- 操作：查看日志详情、重试失败任务

### 2. API接口封装

**文件**: `vue-frontend/src/api/crawler.ts`

```typescript
// 爬虫管理
export const getCrawlers = () => request.get('/api/unified/crawlers');
export const getCrawlerSchema = (name: string) => request.get(`/api/unified/schemas/${name}`);
export const enableCrawler = (name: string) => request.put(`/api/unified/crawlers/${name}/enable`);
export const disableCrawler = (name: string) => request.put(`/api/unified/crawlers/${name}/disable`);

// 参数预设
export const getPresets = (params?: any) => request.get('/api/unified/presets', { params });
export const createPreset = (data: any) => request.post('/api/unified/presets', data);
export const updatePreset = (id: number, data: any) => request.put(`/api/unified/presets/${id}`, data);
export const copyPreset = (id: number, newName: string) => request.post(`/api/unified/presets/${id}/copy`, { newName });
export const deletePreset = (id: number) => request.delete(`/api/unified/presets/${id}`);
export const validateParams = (crawlerName: string, params: any) => request.post('/api/unified/presets/validate', { crawlerName, params });

// 任务执行
export const triggerTask = (id: number) => request.post(`/api/unified/tasks/${id}/trigger`);
export const pauseTask = (id: number) => request.post(`/api/unified/tasks/${id}/pause`);
export const resumeTask = (id: number) => request.post(`/api/unified/tasks/${id}/resume`);

// 监控查询
export const getRunningTasks = () => request.get('/api/unified/monitor/running');
export const getExecutionHistory = (params?: any) => request.get('/api/unified/monitor/history', { params });
export const getTaskStatistics = (id: number) => request.get(`/api/unified/monitor/statistics/${id}`);
```

## 三、实施步骤

1. **后端基础** - 创建适配器、动态调度服务（核心）
2. **后端接口** - 完善Controller接口
3. **前端组件** - 创建子组件和表单
4. **前端集成** - 重构主页面，连接API
5. **联调测试** - 前后端联调验证

## 四、关键文件清单

### 后端新增/修改

1. `CrawlerRegistryService.java` - 增强（启用/停用）
2. `adapter/*.java` - 新增11个适配器
3. `ParamPresetService.java` - 新增
4. `DynamicTaskSchedulerService.java` - 新增
5. `TaskExecutionService.java` - 新增
6. `CrawlerMonitorService.java` - 新增
7. `SchedulerConfig.java` - 新增
8. `UnifiedCrawlerController.java` - 完善

### 前端新增/修改

1. `UnifiedCrawlerManagement.vue` - 重构
2. `CrawlerRegistryPanel.vue` - 新增
3. `ParamPresetPanel.vue` - 新增
4. `DynamicParamForm.vue` - 新增
5. `CronHelper.vue` - 新增
6. `ExecutionMonitorPanel.vue` - 新增
7. `src/api/crawler.ts` - 完善

### To-dos

- [ ] 创建11个爬虫适配器类实现ICrawlerExecutor接口（US510K、USRecall、USRegistration、USEvent、USGuidance、USCustomsCase、EURecall、EURegistration、EUGuidance、EUCustomsCase、KRRecall）
- [ ] 创建DynamicTaskSchedulerService实现动态定时调度（基于Spring TaskScheduler，支持Cron表达式）
- [ ] 创建TaskExecutionService实现任务执行引擎（参数校验、执行日志、结果记录）
- [ ] 创建ParamPresetService实现参数预设管理（创建、更新、复制、删除、验证）
- [ ] 创建CrawlerMonitorService实现监控统计功能（运行任务、执行历史、统计分析）
- [ ] 创建SchedulerConfig配置类并增强CrawlerRegistryService（添加启用/停用功能）
- [ ] 完善UnifiedCrawlerController添加所有API接口（爬虫管理、预设管理、任务调度、监控查询）
- [ ] 完善前端API接口封装（crawler.ts），对接所有后端接口
- [ ] 创建5个前端子组件（CrawlerRegistryPanel、ParamPresetPanel、DynamicParamForm、CronHelper、ExecutionMonitorPanel）
- [ ] 重构UnifiedCrawlerManagement.vue主页面，集成所有子组件并实现前后端完整对接
- [ ] 前后端联调测试，验证完整流程（创建预设→启动定时任务→监控执行→查看日志）