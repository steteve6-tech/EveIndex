name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      backup_timestamp:
        description: 'Backup timestamp (YYYYMMDD_HHMMSS) - leave empty for latest'
        required: false
        type: string

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: Rollback Production
      if: github.event.inputs.environment == 'production'
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        port: ${{ secrets.PORT }}
        script: |
          PROJECT_NAME="AAAA"
          DEPLOY_PATH="/opt/$PROJECT_NAME"
          BACKUP_PATH="/opt/backups"
          NGINX_ROOT="/var/www/html"
          
          echo "=== å¼€å§‹å›æ»šç”Ÿäº§ç¯å¢ƒ ==="
          
          # æ‰¾åˆ°æœ€æ–°çš„å¤‡ä»½
          if [ -n "${{ github.event.inputs.backup_timestamp }}" ]; then
            BACKUP_DIR="$BACKUP_PATH/$PROJECT_NAME-backup-${{ github.event.inputs.backup_timestamp }}"
          else
            BACKUP_DIR=$(ls -dt $BACKUP_PATH/$PROJECT_NAME-backup-* 2>/dev/null | head -1)
          fi
          
          if [ -z "$BACKUP_DIR" ] || [ ! -d "$BACKUP_DIR" ]; then
            echo "âŒ æœªæ‰¾åˆ°å¯ç”¨çš„å¤‡ä»½"
            exit 1
          fi
          
          echo "ä½¿ç”¨å¤‡ä»½: $BACKUP_DIR"
          
          # åœæ­¢å½“å‰æœåŠ¡
          echo "åœæ­¢å½“å‰æœåŠ¡..."
          pkill -f "spring-boot-backend" || true
          sleep 5
          
          # å›æ»šåç«¯
          echo "å›æ»šåç«¯..."
          if [ -f "$BACKUP_DIR/spring-boot-backend/target/"*.jar ]; then
            cp "$BACKUP_DIR/spring-boot-backend/target/"*.jar "$DEPLOY_PATH/spring-boot-backend/target/"
            
            # å¯åŠ¨å›æ»šåçš„æœåŠ¡
            cd "$DEPLOY_PATH/spring-boot-backend"
            nohup java -jar target/*.jar \
              --spring.profiles.active=prod \
              --server.port=8080 \
              > "$DEPLOY_PATH/logs/rollback.log" 2>&1 &
          fi
          
          # å›æ»šå‰ç«¯
          echo "å›æ»šå‰ç«¯..."
          FRONTEND_BACKUP="$BACKUP_PATH/frontend-backup-"$(basename "$BACKUP_DIR" | cut -d'-' -f3-4)
          if [ -d "$FRONTEND_BACKUP" ]; then
            sudo rm -rf $NGINX_ROOT/*
            sudo cp -r $FRONTEND_BACKUP/* $NGINX_ROOT/
            sudo chown -R www-data:www-data $NGINX_ROOT
            sudo systemctl restart nginx
          fi
          
          echo "=== å›æ»šå®Œæˆ ==="
          
          # éªŒè¯æœåŠ¡
          sleep 10
          if curl -s http://localhost:8080/actuator/health | grep -q "UP"; then
            echo "âœ… å›æ»šæˆåŠŸï¼ŒæœåŠ¡æ­£å¸¸è¿è¡Œ"
          else
            echo "âŒ å›æ»šåæœåŠ¡å¼‚å¸¸"
            exit 1
          fi
    
    - name: Rollback Staging
      if: github.event.inputs.environment == 'staging'
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USERNAME }}
        password: ${{ secrets.STAGING_PASSWORD }}
        port: ${{ secrets.STAGING_PORT }}
        script: |
          echo "=== å›æ»šæµ‹è¯•ç¯å¢ƒ ==="
          PROJECT_NAME="AAAA-staging"
          DEPLOY_PATH="/opt/$PROJECT_NAME"
          
          cd $DEPLOY_PATH
          
          # å›æ»šåˆ°ä¸Šä¸€ä¸ªcommit
          git log --oneline -10
          echo "å›æ»šåˆ°ä¸Šä¸€ä¸ªæäº¤..."
          git reset --hard HEAD~1
          
          # é‡æ–°æ„å»ºå’Œéƒ¨ç½²
          cd spring-boot-backend
          mvn clean package -DskipTests
          
          pkill -f "$PROJECT_NAME" || true
          sleep 3
          
          nohup java -jar target/*.jar \
            --spring.profiles.active=staging \
            --server.port=8081 \
            > ../logs/rollback-staging.log 2>&1 &
          
          echo "æµ‹è¯•ç¯å¢ƒå›æ»šå®Œæˆ"
    
    - name: Send Rollback Notification
      run: |
        echo "ğŸ”„ å›æ»šå®Œæˆé€šçŸ¥"
        echo "ç¯å¢ƒ: ${{ github.event.inputs.environment }}"
        echo "æ—¶é—´: $(date)"
        if [ -n "${{ github.event.inputs.backup_timestamp }}" ]; then
          echo "å¤‡ä»½æ—¶é—´æˆ³: ${{ github.event.inputs.backup_timestamp }}"
        fi
