name: Deploy to Production Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ closed ]

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: vue-frontend/package-lock.json
    
    - name: Test Backend
      run: |
        cd spring-boot-backend
        mvn test
    
    - name: Test Frontend
      run: |
        cd vue-frontend
        npm ci
        npm run test:unit || echo "å‰ç«¯æµ‹è¯•è·³è¿‡"

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: vue-frontend/package-lock.json
    
    - name: Build Backend
      run: |
        cd spring-boot-backend
        mvn clean package -DskipTests
        echo "Backend build completed"
    
    - name: Build Frontend
      run: |
        cd vue-frontend
        npm ci
        npm run build
        echo "Frontend build completed"
    
    - name: Create deployment package
      run: |
        mkdir -p deployment
        cp -r spring-boot-backend/target/*.jar deployment/
        cp -r vue-frontend/dist deployment/frontend
        echo "Deployment package created"
    
    - name: Deploy to Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        port: ${{ secrets.PORT }}
        script: |
          # è®¾ç½®å˜é‡
          PROJECT_NAME="AAAA"
          DEPLOY_PATH="/opt/$PROJECT_NAME"
          BACKUP_PATH="/opt/backups"
          NGINX_ROOT="/var/www/html"
          
          echo "=== å¼€å§‹éƒ¨ç½² ==="
          
          # åˆ›å»ºå¿…è¦ç›®å½•
          sudo mkdir -p $DEPLOY_PATH/logs
          sudo mkdir -p $BACKUP_PATH
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd $DEPLOY_PATH
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "æ‹‰å–æœ€æ–°ä»£ç ..."
          git fetch origin
          git reset --hard origin/main
          git clean -fd
          
          # å¤‡ä»½å½“å‰è¿è¡Œçš„æœåŠ¡
          echo "å¤‡ä»½å½“å‰æœåŠ¡..."
          if pgrep -f "spring-boot-backend" > /dev/null; then
            echo "åœæ­¢åç«¯æœåŠ¡..."
            pkill -f "spring-boot-backend" || true
            sleep 5
          fi
          
          # éƒ¨ç½²åç«¯
          echo "=== éƒ¨ç½²åç«¯ ==="
          cd $DEPLOY_PATH/spring-boot-backend
          
          # æ„å»ºåç«¯
          mvn clean package -DskipTests -q
          
          # å¯åŠ¨åç«¯æœåŠ¡
          echo "å¯åŠ¨åç«¯æœåŠ¡..."
          nohup java -jar target/*.jar \
            --spring.profiles.active=prod \
            --server.port=8080 \
            --logging.file.name=$DEPLOY_PATH/logs/backend.log \
            > $DEPLOY_PATH/logs/backend-startup.log 2>&1 &
          
          # ç­‰å¾…åç«¯å¯åŠ¨
          echo "ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/actuator/health &>/dev/null; then
              echo "åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
              break
            fi
            sleep 2
          done
          
          # éƒ¨ç½²å‰ç«¯
          echo "=== éƒ¨ç½²å‰ç«¯ ==="
          cd $DEPLOY_PATH/vue-frontend
          
          # å®‰è£…ä¾èµ–å¹¶æ„å»º
          npm ci --silent
          npm run build
          
          # å¤‡ä»½ç°æœ‰å‰ç«¯æ–‡ä»¶
          if [ -d "$NGINX_ROOT" ] && [ "$(ls -A $NGINX_ROOT)" ]; then
            sudo cp -r $NGINX_ROOT $BACKUP_PATH/frontend-backup-$(date +%Y%m%d_%H%M%S)
          fi
          
          # éƒ¨ç½²å‰ç«¯æ–‡ä»¶
          echo "éƒ¨ç½²å‰ç«¯æ–‡ä»¶..."
          sudo rm -rf $NGINX_ROOT/*
          sudo cp -r dist/* $NGINX_ROOT/
          sudo chown -R www-data:www-data $NGINX_ROOT
          
          # é‡å¯Nginx
          sudo systemctl restart nginx
          
          echo "=== éƒ¨ç½²å®Œæˆ ==="
          echo "å‰ç«¯è®¿é—®: http://$(curl -s ifconfig.me)"
          echo "åç«¯ç«¯å£: 8080"
    
    - name: Health Check
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        port: ${{ secrets.PORT }}
        script: |
          echo "=== å¥åº·æ£€æŸ¥ ==="
          
          # æ£€æŸ¥åç«¯æœåŠ¡
          if curl -s http://localhost:8080/actuator/health | grep -q "UP"; then
            echo "âœ… åç«¯æœåŠ¡å¥åº·"
          else
            echo "âŒ åç«¯æœåŠ¡å¼‚å¸¸"
            exit 1
          fi
          
          # æ£€æŸ¥å‰ç«¯æœåŠ¡
          if curl -s http://localhost/ | grep -q "html"; then
            echo "âœ… å‰ç«¯æœåŠ¡å¥åº·"
          else
            echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
          fi
          
          # æ£€æŸ¥NginxçŠ¶æ€
          if sudo systemctl is-active --quiet nginx; then
            echo "âœ… NginxæœåŠ¡æ­£å¸¸"
          else
            echo "âŒ NginxæœåŠ¡å¼‚å¸¸"
          fi
          
          echo "å¥åº·æ£€æŸ¥å®Œæˆ"

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: always()
    
    steps:
    - name: Send Success Notification
      if: needs.build-and-deploy.result == 'success'
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸé€šçŸ¥"
        echo "é¡¹ç›®å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨"
        echo "è®¿é—®åœ°å€: http://${{ secrets.HOST }}"
    
    - name: Send Failure Notification
      if: needs.build-and-deploy.result == 'failure'
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥"
        echo "é¡¹ç›®éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        exit 1
